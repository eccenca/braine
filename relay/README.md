# Relay
This tool reads metrics from k8s metrics server and write it to a selected outputstream.

## Dependencies
There are three not standard libraries that required to be preinstalled:
```
pip install yaml # required for reading configuration file
pip install kubernetes # for kubernetes API
pip install cmem-cmempy # for communicating with CMEM
```

## Configuration

The configuration can be setup by editing the ```config.yaml``` file as follows:

### Relay

out: use this parameter to add or remove an outputstream channel.
The relay supports two types of outputstreams ```stdout``` (default) and ```cmem```.

origin: use this parameter to select a inputstream. In this current version, it is not 
possible to change the origin, but Kafka will be added in the near future.

```interval```: this parameter is useful to change the frequency (in seconds) of relay read/write operations (default ```1```).

```mode```: this parameter is use to setup asyncronous (```async```) or synchronous (```sync```) read/write modes (default ```sync```).

```version```: use this parameter to setup the k8s metrics server API version. Currently only supported ```v1beta1```.

```group```: this parameter sets the message group. Use ```metrics.k8s.io``` for messages generated by k8s metrics server (default).

```kind```: this parameter setup the type of metrics that should be readed from the inputstream (```node``` or ```pod```).

### CMEM

```cmemc.update.graph```: use this parameter to setup the target graph in CMEM.

```cmemc.node.template```: this parameter sets the template file containing the node triple template to be inserted.

```cmemc.pod.template```: this parameter sets the template file to the pod triple template to be inserted.

```cmemc.update.template```: this parameter sets the template file to the INSERT query.


#### Example

```
# Relay configuration
origin: kubernetes # origin 'kubernetes' (using default kubernetes configuraion) or 'kafka'
kind: node
# pod.namespace: default # only possible for kind 'pod'
version: v1beta1 # api version current supports only 'v1beta1'
interval: 30 # interval in seconds
mode: async # broadcasting can be in 'sync' (default) or 'async' modes
out: # available options 'stdout' and 'cmem'
  - stdout # output to stdout
  - cmem # output to cmem
group: metrics.k8s.io # group, use 'metrics.k8s.io' for metrics server

# CMEM configuration
cmemc.update.graph: https://vocab.eccenca.com/itops/kubernetes # target GRAPH
cmemc.node.template: node.template.nt # node template triples
cmemc.pod.template: pod.template.nt # pod template triples
cmemc.update.template: cmem.update.tempalte.sparql # SPARQL insert template
```

## Updating CMEM credentials
If you are working with CMEM edit the script ```itops-relay.py``` adding your credentiials as follows:

Select your authentication type and replace the question mark (?) by your respective credentials.

For cmemc authentication using user and password:
```
# setup the environment for the connection to Corporate Memory
environ["CMEM_BASE_URI"] = "https://braine.eccenca.dev/" # target cmem instance when writing to 'cmem'
# use the following for 'password' OAUTH_GRANT_TYPE
environ["OAUTH_GRANT_TYPE"] = "password"
environ["OAUTH_USER"] = "?"
environ["OAUTH_PASSWORD"] = "?"
environ["OAUTH_CLIENT_ID"] = "cmemc"
```

For service account authentication type:
```
environ["CMEM_BASE_URI"] = "https://braine.eccenca.dev/" # target cmem instance when writing to 'cmem'
# use the following for 'client_credentials' OAUTH_GRANT_TYPE
environ["OAUTH_GRANT_TYPE"] = "client_credentials"
environ["OAUTH_CLIENT_ID"] = "cmem-service-account"
environ["OAUTH_CLIENT_SECRET"] = "?"
```

## Usage 
Now we are all set.
Execute ```itops-relay.py``` with the following command
```
python itops-relay.py
```

